{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container-fluid mt-4">
{% if collection %}
  <div hx-get="{% url 'order:shopping_cart' %}" hx-trigger="load, items-updated from:body"></div>
{% endif %}
  <hr>
  <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 align-items-stretch">
    {% for product in products %}
      <div class="col">
        <div class="card h-100 text-center border-0 rounded-4 shadow-sm card-hover d-flex flex-column justify-content-between">
          <img src="{{ product.image.url }}"
               class="card-img-top rounded-top"
               alt="{{ product.name }}"
               style="height:225px; object-fit:cover;">
          <div class="card-body d-flex flex-column justify-content-between">
            <h5 class="card-title fw-bold">{{ product.name }}</h5>

            <!-- Price Display -->
            <div class="mb-3">
              <div class="d-flex justify-content-center gap-2">
                <div class="text-center">
                  <small class="d-block text-muted">Price</small>
                  <span class="badge bg-secondary"
                        id="product-price-{{ product.id }}"
                        hx-get="{% url 'order:get_variant_price' product.id %}"
                        hx-trigger="change from:#category-{{ product.id }},
                                    change from:#color-{{ product.id }},
                                    change from:#size-{{ product.id }},
                                    input from:#back-name-{{ product.id }}"
                        hx-include="#category-{{ product.id }},
                                    #color-{{ product.id }},
                                    #size-{{ product.id }},
                                    #back-name-{{ product.id }}">
                    <i class="bi bi-currency-dollar"></i>0.00
                  </span>
                </div>
              </div>
            </div>

            <!-- Add to Order Form -->
            <form method="POST" hx-post="{% url 'order:add_item' %}" class="m-auto">
              {% csrf_token %}
              <input type="hidden" name="product" value="{{ product.id }}">

              <!-- Row 1: Category + Color -->
              <div class="row mb-3">
                <div class="col-md-6">
                  <div class="form-floating">
                    <select name="category" id="category-{{ product.id }}" class="form-select" required
                            hx-get="{% url 'order:get_variant_sizes' product.id %}"
                            hx-target="#size-{{ product.id }}"
                            hx-trigger="change"
                            hx-include="#category-{{ product.id }}, #color-{{ product.id }}">
                      <option value="">Select Type</option>
                      {% for category in product.category.all %}
                        <option value="{{ category.id }}">{{ category.name }}</option>
                      {% endfor %}
                    </select>
                    <label for="category-{{ product.id }}">Type</label>
                  </div>
                </div>

                <div class="col-md-6">
                  <div class="form-floating">
                    <select name="color" id="color-{{ product.id }}" class="form-select" required
                            hx-get="{% url 'order:get_variant_sizes' product.id %}"
                            hx-target="#size-{{ product.id }}"
                            hx-trigger="change"
                            hx-include="#category-{{ product.id }}, #color-{{ product.id }}">
                      {% for color in product.colors.all %}
                        <option value="{{ color.id }}">{{ color.name }}</option>
                      {% endfor %}
                    </select>
                    <label for="color-{{ product.id }}">Color</label>
                  </div>
                </div>
              </div>

              <!-- Row 2: Size + Quantity -->
              <div class="row mb-3">
                <div class="col-md-6">
                  <div class="form-floating">
                    <select name="size" id="size-{{ product.id }}" class="form-select" required
                            hx-get="{% url 'order:get_variant_sizes' product.id %}"
                            hx-target="#size-options-{{ product.id }}"
                            hx-trigger="change from:#category-{{ product.id }}, change from:#color-{{ product.id }}"
                            hx-include="#category-{{ product.id }}, #color-{{ product.id }}">
                      <span id="size-options-{{ product.id }}">
                        {% for size, label in product.get_available_sizes %}
                          <option value="{{ size }}">{{ label }}</option>
                        {% endfor %}
                      </span>
                    </select>
                    <label for="size-{{ product.id }}">Size</label>
                  </div>
                </div>

                <div class="col-md-6">
                  <div class="form-floating">
                    <input type="number" name="quantity" id="quantity-{{ product.id }}"
                           value="1" min="1" class="form-control" required>
                    <label for="quantity-{{ product.id }}">Quantity</label>
                  </div>
                </div>
              </div>

              <!-- Optional Back Name Section -->
              {% if product.has_back_name %}
                <div class="text-start mb-3">
                  <button class="btn btn-link text-purple-600 text-decoration-none p-0"
                          type="button"
                          data-bs-toggle="collapse"
                          data-bs-target="#backNameField-{{ product.id }}"
                          aria-expanded="false">
                    Add name to back? (+$2)
                  </button>
                  <div class="collapse mt-2" id="backNameField-{{ product.id }}">
                    <div class="form-floating">
                      <input type="text"
                             name="back_name"
                             id="back-name-{{ product.id }}"
                             class="form-control"
                             placeholder="Enter last name"
                             hx-get="{% url 'order:get_variant_price' product.id %}"
                             hx-trigger="input changed delay:300ms"
                             hx-target="#product-price-{{ product.id }}"
                             hx-include="#category-{{ product.id }},
                                        #color-{{ product.id }},
                                        #size-{{ product.id }},
                                        #back-name-{{ product.id }}">
                      <label for="back-name-{{ product.id }}">Last Name on Back</label>
                    </div>
                  </div>
                </div>
              {% endif %}

              <button type="submit" class="btn btn-primary w-100 shadow-sm">
                Add to Order
              </button>
            </form>
          </div>
        </div>
      </div>
    {% empty %}
      <div>No Products Available</div>
    {% endfor %}
  </div>
</div>
{% endblock %}